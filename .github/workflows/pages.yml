on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write
  actions: read

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Pages (configure runner for Pages)
        id: pages
        uses: actions/configure-pages@v5
        with:
          static_site_generator: next

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          if [ -f package-lock.json ]; then
            npm ci || npm install
          else
            npm install
          fi

      - name: Build
        shell: bash
        run: npm run build

      - name: Static HTML export
        shell: bash
        run: npm run export

      - name: Prepare Pages artifact directory (sanitize)
        shell: bash
        run: |
          set -Eeuo pipefail
          if [ ! -d "out" ]; then
            echo "Exported folder 'out' not found. Did 'npm run export' succeed?" >&2
            exit 1
          fi
          rm -rf _site
          mkdir -p _site
          # Prefer rsync if available, else fallback to cp -a
          if command -v rsync >/dev/null 2>&1; then
            rsync -a --delete "out/" "_site/"
          else
            cp -a out/. _site/
          fi
          # Ensure Jekyll processing is disabled
          touch "_site/.nojekyll"

      - name: Break any hardlinks in _site
        shell: bash
        run: |
          set -Eeuo pipefail
          if [ ! -d "_site" ]; then
            echo "_site not found" >&2
            exit 1
          fi
          # Rewrite each regular file to ensure it is not a hardlink
          find "_site" -type f -print0 | while IFS= read -r -d '' f; do
            tmp="${f}.tmp.$$"
            cp -p "$f" "$tmp" && mv -f "$tmp" "$f"
          done

      - name: Verify artifact content (no links, size <10GB)
        shell: bash
        run: |
          set -Eeuo pipefail
          if [ ! -d "_site" ]; then
            echo "_site not found" >&2
            exit 1
          fi
          # Fail if any symlinks are present
          mapfile -t links < <(find "_site" -type l)
          if [ ${#links[@]} -gt 0 ]; then
            echo "Found symlinks, these are not allowed:" >&2
            for l in "${links[@]}"; do echo " - $l"; done
            echo "Artifact contains links." >&2
            exit 1
          fi
          # Compute size in bytes and ensure < 10 GiB
          sizeBytes=$(du -sb "_site" | cut -f1)
          sizeGB=$(awk -v s="$sizeBytes" 'BEGIN { printf "%.3f", s/1073741824 }')
          echo "Artifact size: ${sizeBytes} bytes (~${sizeGB} GiB)"
          limit=$((10*1024*1024*1024))
          if [ "$sizeBytes" -gt "$limit" ]; then
            echo "Artifact too large (>=10 GiB limit)." >&2
            exit 1
          fi

      - name: Upload build as generic artifact
        uses: actions/upload-artifact@v4
        with:
          name: site
          path: ./_site

  package:
    runs-on: self-hosted
    needs: build
    steps:
      - name: Download site artifact
        uses: actions/download-artifact@v4
        with:
          name: site
          path: _site

      - name: Upload artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  publish:
    runs-on: self-hosted
    needs: package
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
